---
# Coraza WAF via proxy-wasm — applies to all traffic through the Gateway.
# Uses per_authority_directives to apply tuned rulesets per hostname:
# - gRPC services (ArgoCD, Hydra) get rule exclusions for binary protobuf
# - All other traffic gets the full OWASP CRS
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: coraza-waf
  namespace: envoy-gateway-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-gateway
  wasm:
    - name: coraza-filter
      code:
        type: HTTP
        http:
          url: http://coraza-wasm-server.envoy-gateway-system.svc.cluster.local/coraza-proxy-wasm.wasm
          sha256: {{ .Values.waf.sha256 }}
      failOpen: {{ .Values.waf.failOpen }}
      config:
        directives_map:
          # Full OWASP CRS — applied to all HTTP traffic by default
          default:
            - "Include @recommended-conf"
            - "SecRuleEngine {{ .Values.waf.ruleEngine }}"
            - "SecDebugLogLevel 3"
            - "Include @crs-setup-conf"
            - "Include @owasp_crs/*.conf"
          # Tuned ruleset for gRPC services (binary protobuf triggers false positives)
          # Excludes: 920420 (content-type), 920270 (null chars), 921150 (CRLF in body)
          grpc:
            - "Include @recommended-conf"
            - "SecRuleEngine {{ .Values.waf.ruleEngine }}"
            - "SecDebugLogLevel 3"
            - "Include @crs-setup-conf"
            - "Include @owasp_crs/*.conf"
            - "SecRuleRemoveById 920420"
            - "SecRuleRemoveById 920270"
            - "SecRuleRemoveById 921150"
        default_directives: "default"
        per_authority_directives:
          argocd.cluster.samuelbagattin.com: "grpc"
          auth.cluster.samuelbagattin.com: "grpc"
